/* eslint-disable jsx-a11y/alt-text */
import React from 'react';
import { Document, Page, Text, View, Image, StyleSheet } from '@react-pdf/renderer';
import { Villa } from '../types';
import { translations } from '../i18n/translations';
import { optimizeImageForPDF } from '../utils/pdfHelpers';
import { translateDate } from '../utils/dateTranslation';
import path from 'path';

// Get absolute path to logo for PDF generation (server-side)
const getLogoPath = () => {
    if (typeof window === 'undefined') {
        // Server-side: use absolute file path
        return path.join(process.cwd(), 'public', 'logo-sbh.png');
    }
    // Client-side (shouldn't happen for PDF): use relative path
    return '/logo-sbh.png';
};

// Define color palette matching design system
const colors = {
    charcoal: '#2D2D2D',
    cream: '#FAF8F3',
    green: '#7FA99B',
    blue: '#4A90A4',
    stone: '#8B7E74',
    white: '#FFFFFF',
    gray: '#6B7280',
};

// Helper function to truncate text with ellipsis
const truncateText = (text: string, maxLength: number): string => {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '...';
};

// PDF Styles - Optimized for portrait format with full content
const styles = StyleSheet.create({
    page: {
        backgroundColor: colors.cream,
        padding: 0,
    },
    // Compact Header - Logo on right
    header: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 30,
        paddingBottom: 20,
        borderBottom: `1px solid #E0E0E0`,
    },
    logoImage: {
        width: 100,
        height: 60,
        objectFit: 'contain',
    },
    villaName: {
        fontSize: 24,
        fontFamily: 'Times-Italic',
        color: colors.charcoal,
    },
    // Hero Section - Reduced height
    heroSection: {
        width: '100%',
        height: 220,
        marginBottom: 0,
    },
    heroImage: {
        width: '100%',
        height: '100%',
        objectFit: 'cover',
    },
    // Location bar - Compact
    locationBar: {
        backgroundColor: colors.white,
        padding: 10,
        paddingHorizontal: 30,
    },
    locationText: {
        fontSize: 8,
        fontFamily: 'Helvetica',
        color: colors.gray,
        letterSpacing: 2,
        textTransform: 'uppercase',
    },
    // Details Grid - No bottom border to save space
    detailsGrid: {
        flexDirection: 'row',
        justifyContent: 'space-around',
        padding: 18,
        paddingHorizontal: 30,
    },
    detailItem: {
        alignItems: 'center',
    },
    detailLabel: {
        fontSize: 7,
        fontFamily: 'Helvetica',
        color: colors.gray,
        textTransform: 'uppercase',
        letterSpacing: 1.5,
        marginBottom: 4,
    },
    detailValue: {
        fontSize: 18,
        fontFamily: 'Helvetica-Bold',
        color: colors.charcoal,
    },
    // Content Section - Full width for description
    contentSection: {
        padding: 20,
        paddingHorizontal: 30,
        paddingBottom: 15,
    },
    sectionTitle: {
        fontSize: 13,
        fontFamily: 'Times-Italic',
        color: colors.charcoal,
        marginBottom: 8,
    },
    description: {
        fontSize: 8.5,
        fontFamily: 'Helvetica',
        color: colors.gray,
        lineHeight: 1.5,
        textAlign: 'justify',
    },
    // Amenities Section - 2 columns, no limit
    amenitiesSection: {
        paddingHorizontal: 30,
        paddingTop: 15,
        paddingBottom: 80, // Space for footer
        backgroundColor: colors.cream,
    },
    amenitiesGrid: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 6,
    },
    amenityItem: {
        flexDirection: 'row',
        alignItems: 'flex-start',
        gap: 5,
        width: '48%',
        marginBottom: 4,
    },
    amenityBullet: {
        fontSize: 9,
        color: colors.green,
        marginTop: 1,
    },
    amenityLabel: {
        fontSize: 8,
        fontFamily: 'Helvetica',
        color: colors.charcoal,
        flex: 1,
        lineHeight: 1.2,
    },
    // Pricing Section - Page 2
    pricingSection: {
        padding: 30,
        paddingTop: 20,
        paddingBottom: 20,
    },
    priceTable: {
        marginTop: 12,
        gap: 5,
    },
    priceRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        paddingVertical: 8,
        paddingHorizontal: 12,
        backgroundColor: colors.white,
    },
    priceLabel: {
        fontSize: 9,
        fontFamily: 'Helvetica',
        color: colors.charcoal,
    },
    priceValue: {
        fontSize: 10,
        fontFamily: 'Helvetica-Bold',
        color: colors.green,
    },
    // Gallery - Portrait format, 2 photos per page
    gallerySection: {
        padding: 30,
        paddingTop: 20,
        paddingBottom: 70,
    },
    galleryGrid: {
        flexDirection: 'column',
        gap: 15,
    },
    galleryImage: {
        width: '100%',
        height: 280,
        objectFit: 'cover',
    },
    // Compact Footer
    footer: {
        position: 'absolute',
        bottom: 0,
        left: 0,
        right: 0,
        padding: 18,
        paddingHorizontal: 30,
        backgroundColor: '#C3CBC4',
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
    },
    footerText: {
        fontSize: 7,
        fontFamily: 'Helvetica',
        color: colors.charcoal,
        lineHeight: 1.5,
    },
    footerBold: {
        fontSize: 8,
        fontFamily: 'Helvetica-Bold',
        color: colors.charcoal,
    },
});

interface VillaBrochurePDFProps {
    villa: Villa;
    language?: 'fr' | 'en';
}

// Helper to normalize season names to translation keys
const getSeasonTranslationKey = (rawName: string | undefined): keyof import('../i18n/translations').Translations['villa']['seasons'] | null => {
    if (!rawName) return null;
    const lower = rawName.toLowerCase();
    if (lower.includes('low') || lower.includes('basse')) return 'lowSeason';
    if (lower.includes('high') || lower.includes('haute')) return 'highSeason';
    if (lower.includes('summer') || lower.includes('été')) return 'summer';
    if (lower.includes('thanksgiving')) return 'thanksgiving';
    if (lower.includes('christmas') || lower.includes('noël')) return 'christmas';
    if (lower.includes('new year') || lower.includes('nouvel')) return 'newYear';
    return null;
};

export const VillaBrochurePDF: React.FC<VillaBrochurePDFProps> = ({ villa, language = 'fr' }) => {
    const pdfOptions = villa.pdfOptions || {};
    const includeSeasonalPricing = pdfOptions.includeSeasonalPricing === true;
    const isSale = villa.listingType === 'sale';
    const t = translations[language];

    // Visibility Logic - Show seasonal pricing if enabled
    console.log('PDF Options:', pdfOptions);
    console.log('Include Seasonal Pricing:', includeSeasonalPricing);
    console.log('Is Sale:', isSale);
    console.log('Has Seasonal Prices:', villa.seasonalPrices?.length);

    const showSeasonalPricing = includeSeasonalPricing && !isSale && villa.seasonalPrices && villa.seasonalPrices.length > 0;

    console.log('Show Seasonal Pricing:', showSeasonalPricing);

    // Show all amenities (ensure array exists)
    const displayedAmenities = villa.amenities || [];

    // Get localized description - FULL VERSION (no truncation)
    // @ts-ignore - Handle legacy string or new object structure
    const fullDescription = typeof villa.fullDescription === 'object'
        ? (villa.fullDescription[language] || villa.fullDescription['fr'] || '')
        : (villa.fullDescription || '');

    // Gallery: Split into chunks of 2 for portrait layout
    const galleryImages = villa.galleryImages;
    const galleryPages: string[][] = [];
    for (let i = 0; i < galleryImages.length; i += 2) {
        galleryPages.push(galleryImages.slice(i, i + 2));
    }

    return (
        <Document>
            {/* PAGE 1: Hero + Description + Amenities */}
            <Page size="A4" style={styles.page}>
                {/* Header - Villa name left, logo right */}
                <View style={styles.header}>
                    <Text style={styles.villaName}>{villa.name}</Text>
                    <Image src={getLogoPath()} style={styles.logoImage} />
                </View>

                {/* Hero Image */}
                <View style={styles.heroSection}>
                    <Image
                        src={optimizeImageForPDF(villa.mainImage)}
                        style={styles.heroImage}
                    />
                </View>

                {/* Location */}
                <View style={styles.locationBar}>
                    <Text style={styles.locationText}>
                        {villa.location.name}, Saint-Barthélemy
                    </Text>
                </View>

                {/* Details Grid */}
                <View style={styles.detailsGrid}>
                    <View style={styles.detailItem}>
                        <Text style={styles.detailLabel}>Type</Text>
                        <Text style={styles.detailValue}>{villa.propertyType === 'apartment' ? (language === 'fr' ? 'Appartement' : 'Apartment') : 'Villa'}</Text>
                    </View>
                    <View style={styles.detailItem}>
                        <Text style={styles.detailLabel}>Invités</Text>
                        <Text style={styles.detailValue}>{villa.guests}</Text>
                    </View>
                    <View style={styles.detailItem}>
                        <Text style={styles.detailLabel}>Chambres</Text>
                        <Text style={styles.detailValue}>{villa.bedrooms}</Text>
                    </View>
                    <View style={styles.detailItem}>
                        <Text style={styles.detailLabel}>Salles de Bain</Text>
                        <Text style={styles.detailValue}>{villa.bathrooms}</Text>
                    </View>
                    {isSale && villa.surface && (
                        <View style={styles.detailItem}>
                            <Text style={styles.detailLabel}>Surface</Text>
                            <Text style={styles.detailValue}>{villa.surface} m²</Text>
                        </View>
                    )}
                </View>

                {/* Description - Full width */}
                <View style={styles.contentSection} wrap={false}>
                    <Text style={styles.sectionTitle}>À Propos</Text>
                    <Text style={styles.description}>{fullDescription}</Text>
                </View>

                {/* Amenities - 2 columns grid */}
                <View style={styles.amenitiesSection}>
                    <Text style={styles.sectionTitle}>Équipements</Text>
                    {displayedAmenities && displayedAmenities.length > 0 ? (
                        <View style={styles.amenitiesGrid}>
                            {displayedAmenities.map((amenity, index) => (
                                <View key={index} style={styles.amenityItem}>
                                    <Text style={styles.amenityBullet}>•</Text>
                                    <Text style={styles.amenityLabel}>{amenity.name}</Text>
                                </View>
                            ))}
                        </View>
                    ) : (
                        <Text style={styles.description}>Aucun équipement renseigné</Text>
                    )}
                </View>

                {/* Footer */}
                <View style={styles.footer} fixed>
                    <View>
                        <Text style={styles.footerBold}>Valérie</Text>
                        <Text style={styles.footerText}>+590 690 63 47 25</Text>
                        <Text style={styles.footerText}>valerie@sun-beach-house.com</Text>
                    </View>
                    <View style={{ alignItems: 'flex-end' }}>
                        <Text style={styles.footerBold}>Sun Beach House</Text>
                        <Text style={styles.footerText}>65 RUE DE LA PAIX GUSTAVIA</Text>
                        <Text style={styles.footerText}>97133 SAINT BARTHELEMY</Text>
                    </View>
                </View>
            </Page>

            {/* ADDITIONAL PAGES: Seasonal Pricing (if enabled) + Gallery */}
            {showSeasonalPricing && (
                <Page size="A4" style={styles.page}>
                    <View style={styles.header}>
                        <Text style={{ ...styles.villaName, fontSize: 20 }}>
                            {language === 'fr' ? 'Tarifs Saisonniers' : 'Seasonal Rates'}
                        </Text>
                        <Image src={getLogoPath()} style={styles.logoImage} />
                    </View>

                    {/* Pricing Section */}
                    <View style={styles.pricingSection}>
                        <Text style={styles.sectionTitle}>Tarifs Saisonniers</Text>
                        <View style={styles.priceTable}>
                            {villa.seasonalPrices!.slice(0, 6).map((season, index) => {
                                // Localize
                                const normalizedKey = getSeasonTranslationKey(season.seasonName.name);
                                const translatedName = normalizedKey ? t.villa.seasons[normalizedKey] : season.seasonName.name;
                                // Translate dates: FR by default, auto-translate for other languages
                                const dateString = translateDate(season.dates, language);

                                return (
                                    <View key={index}>
                                        <View style={styles.priceRow}>
                                            <Text style={styles.priceLabel}>
                                                {translatedName} ({dateString})
                                            </Text>
                                            <Text style={styles.priceValue}>
                                                À partir de ${season.prices[0]?.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')}
                                            </Text>
                                        </View>
                                    </View>
                                );
                            })}
                        </View>
                        <Text style={{ ...styles.footerText, marginTop: 10, color: colors.gray }}>
                            Prix par semaine. Service et taxes non inclus.
                        </Text>
                    </View>

                    {/* Footer */}
                    <View style={styles.footer} fixed>
                        <View>
                            <Text style={styles.footerBold}>Valérie</Text>
                            <Text style={styles.footerText}>+590 690 63 47 25</Text>
                            <Text style={styles.footerText}>valerie@sun-beach-house.com</Text>
                        </View>
                        <View style={{ alignItems: 'flex-end' }}>
                            <Text style={styles.footerBold}>Sun Beach House</Text>
                            <Text style={styles.footerText}>65 RUE DE LA PAIX GUSTAVIA</Text>
                            <Text style={styles.footerText}>97133 SAINT BARTHELEMY</Text>
                        </View>
                    </View>
                </Page>
            )}

            {/* GALLERY PAGES - 2 photos per page in portrait */}
            {galleryPages.map((pageImages, pageIndex) => (
                <Page key={pageIndex} size="A4" style={styles.page}>
                    <View style={styles.header}>
                        <Text style={{ ...styles.villaName, fontSize: 20 }}>
                            {language === 'fr' ? 'Galerie Photos' : 'Photo Gallery'}
                        </Text>
                        <Image src={getLogoPath()} style={styles.logoImage} />
                    </View>

                    <View style={styles.gallerySection}>
                        <View style={styles.galleryGrid}>
                            {pageImages.map((img, index) => (
                                <Image
                                    key={index}
                                    src={optimizeImageForPDF(img)}
                                    style={styles.galleryImage}
                                />
                            ))}
                        </View>
                    </View>

                    {/* Footer */}
                    <View style={styles.footer} fixed>
                        <View>
                            <Text style={styles.footerBold}>Valérie</Text>
                            <Text style={styles.footerText}>+590 690 63 47 25</Text>
                            <Text style={styles.footerText}>valerie@sun-beach-house.com</Text>
                        </View>
                        <View style={{ alignItems: 'flex-end' }}>
                            <Text style={styles.footerBold}>Sun Beach House</Text>
                            <Text style={styles.footerText}>65 RUE DE LA PAIX GUSTAVIA</Text>
                            <Text style={styles.footerText}>97133 SAINT BARTHELEMY</Text>
                        </View>
                    </View>
                </Page>
            ))}
        </Document>
    );
};
